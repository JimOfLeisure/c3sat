<!DOCTYPE HTML>
<html>
<head>
  <title>Civ3 Show-and-Tell JSON/d3/SVG Map</title>
  <link rel="stylesheet" type="text/css" href="svgmap.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js" charset="utf-8"></script>
<script>

var resources = {
    0x08: '\uD83C\uDF47', // "#myWines" 
    0x09: 'Furs', // Furs
    0x0c: 'Spices', // Spices
    0x0d: '\uD83D\uDC18', // Unicode elephant // Ivory
    0x0a: 'Dyes', // Dyes
    0x0b: 'Incense', // Incense
    0x0e: 'Silks', // Silks
    0x0f: '\uD83D\uDC8E', // Gems
    // 0x10: '\uD83D\uDC33', // Spouting whale // Whales
    0x10: '\uD83D\uDC0B', // Whales
    0x11: '\uD800\uDC82', // Deer
    0x12: '\uD83D\uDC1F', // Fish
    0x13: '\uD83D\uDC04', // Cow
    0x14: 'Wheat', // Wheat
    0x15: 'Gold', // Gold
    0x16: 'Sugar', // Sugar
    0x17: '\uD83C\uDF4C', // Trop.Fruit
    // 0x18: '\uD83C\uDFDD', // Unicode desert island // Oasis
    // 0x18: 'Oasis', // Oasis
    0x18: '\uD83C\uDF34', // Unicode palm tree // Oasis
    // 0x19: 'Tobacco' // Tobacco
    0x19: '\uD83D\uDEAC' // Unicode smoking // Tobacco
}
// console.log('Resource object test:');
// Object.keys(resources).forEach(function(key){ console.log(key, resources[key]); });

var overlay = {
    0x05: '#myHill',
    0x06: '#myMountain',
    0x07: '#myForest',
    0x08: '#myJungle',
    0x09: '#myMarsh',
    0x0a: '#myVolcano'
}

// load map json file
d3.json("civmap.json", function(error, data){
    if (error) return console.warn(error);
    else
/*
    // Just making sure I have the data
    console.log(data.tile.length); 
    console.log(data.width); 
    console.log(data.height); 
*/

/*
// load svg defs file
var mapdefs = d3.xml("mapdefs.svg", function(error, mapdefs){
    if (error) return console.warn(error);
    else
    console.log('Mapdefs loaded');
    console.log(mapdefs);
    return mapdefs
});
*/

    // Add svg element and assign to var
    var svg = d3.select('svg#map')
       // These xmlns's cause d3 to error out:
       //.attr('xmlns', 'http://www.w3.org/2000/svg')
       //.attr('xmlns:xlink', 'http://www.w3.org/1999/xlink')
       .attr('id', 'map')
       .attr('style', 'background: darkslategray')
       .attr('width', data.width * 64 + 64)
       .attr('height', data.height * 32 + 32);

    // Trying to append mapdefs and failing
    // console.log(svg.selectAll('svg').data(mapdefs).enter().append('svg'))
    // d3.select('svg').data(mapdefs).enter().append('svg');

    var tiles = svg.selectAll('polygon')
        .data(data.tile)
        // causes tiles not to have .enter() -.filter(function(d){ return d.is_visible_to_flags & spoilmask});

    // If callback() is true, remove the node
    var removenodes = function(selection, callback){
        selection.filter(function(d){ return ! callback(d); }).remove();
    }

    // bitmask for "is visible to" value. 0x2 is human player 1, 0x1 is barbs, 0xffff matches all
    var spoilmask = 0x2;
    // spoilmask = 0x4;
    // spoilmask = 0xffff;

    // remove spoiler bindings
    var despoil = function(selection){
      removenodes(selection, function(d){ return d.is_visible_to_flags & spoilmask; } );
    }

    var x = function(i){
       // tile-width * map width, aslo add half-tile offset to the right for odd rows
       return 128 * (i % (data.width / 2)) + 64 * ( Math.floor(i / (data.width /2)) % 2);
    }
    var y = function(i){
       return 32 * Math.floor(i / (data.width / 2));
    }
    // Adds tiles to the DOM
    tiles.enter().append('polygon')
       .attr('points', '0,32 64,0 128,32 64,64')
       // Set transforms for tiles
       .attr('transform', function(d, i) {
          return 'translate(' + x(i).toString() + ',' + y(i).toString() + ')'
       })
       // Assign class based on terrain
       .attr('class', function(d, i) {
          // including itentify flood plains
          return 'terrbase' + (d.info.terrain & 0x0F).toString() + (!(d.info.terrain & 0x0f) && d.rivers ? ' floodplain' : '');
       });

    despoil(tiles);


    // Rivers
    // Currently this draws rivers for every tile then deletes the inappropriate ones
    var rivers = function(selection, x1, y1, x2, y2, mask) {
        selection.enter().append('line')
            .attr('class', 'river')
            .attr('x1', function(d, i) { return x(i) + x1})
            .attr('y1', function(d, i) { return y(i) + y1 })
            .attr('x2', function(d, i) { return x(i) + x2 })
            .attr('y2', function(d, i) { return y(i) + y2});
    
        // Remove spoiler tiles
        despoil(selection);
        // Remove lines for unmatched data
        removenodes(selection, function(d){ return d.rivers & mask; } );
    }
    // NW river
    rivers(tiles, 0, 32, 64, 0, 0x80);
    // NE river
    rivers(tiles, 64, 0, 128, 32, 0x02);
    // SE river
    rivers(tiles, 128, 32, 64, 64, 0x08);
    // SW river
    rivers(tiles, 64, 64, 0, 32, 0x20);

    // Add resources to map
    tiles.enter().append('text')
        .attr('class', 'resource')
        .attr('x', function(d, i) { return x(i) + 64})
        .attr('y', function(d, i) { return y(i) + 32 })
        .text(function(d){ return resources[d.resource]});
    // Remove empty text nodes (those that don't have an entry in resources)
    removenodes(tiles, function(d){ return resources[d.resource] } );

});
</script>
</head>
<body>
  <h1>Civ3 Show-and-Tell JSON/d3/SVG Map</h1>
  <svg id="map" />
</body>
</html>
